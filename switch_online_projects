#!/usr/bin/env bash

set -e

function usage {
    echo "$(basename $0) [-B (bundle)] [-C (clean)] [-G (git)] [-h] [-N (nuke)] [-S (setup_test_db)]"
}

BUNDLE=true
CLEAN=true
GITPULL=true
NUKESCHEMAS=true
SETUPTESTDB=true
TESTS=true

while getopts BGhNT opt; do
    case $opt in
        B)
            BUNDLE=false
            ;;
        C)
            CLEAN=false
            ;;
        G)
            GITPULL=false
            ;;
        h)
            usage
            exit 0
            ;;
        N)
            NUKESCHEMAS=false
            ;;
        S)
            SETUPTESTDB=false
            ;;
    esac
done

if [[ $GITPULL = true ]]; then
    echo ">>> Pulling Git commits"

    if [[ -e "../list" ]]; then
        (
            cd ~/src/work/trampoline
            git pull-list
        )
    else
        git dn
    fi
fi

if [[ $BUNDLE = true ]]; then
    if [ -d "spec/dummy" ]; then
        echo ">>> Building rbenv gemset"
        build_rbenv_gemset $(basename $(pwd))
    else
        echo ">>> Bundling gems"
        bundle
    fi
fi

if [[ $CLEAN = true ]]; then
    if [ -d "spec/dummy" ]; then
        echo ">>> Cleaning spec/dummy"
        rails_engine_clean_spec_dummy
    fi
fi

if [[ $NUKESCHEMAS = true ]]; then
    nuke_schemas
fi

if [[ $SETUPTESTDB = true ]]; then
    echo ">>> setting up test database"
    setup_test_db
fi
