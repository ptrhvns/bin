#!/usr/bin/env bash

set -e

function usage {
    echo "$(basename $0) [-B (bundle)] [-C (clean)] [-G (git)] [-h] [-N (nuke)] [-T (tests)]"
}

BUNDLE=true
CLEAN=true
GITPULL=true
NUKESCHEMAS=true
TESTS=true

while getopts BGhNT opt; do
    case $opt in
        B)
            BUNDLE=false
            ;;
        C)
            CLEAN=false
            ;;
        G)
            GITPULL=false
            ;;
        h)
            usage
            exit 0
            ;;
        N)
            NUKESCHEMAS=false
            ;;
        T)
            TESTS=false
            ;;
    esac
done

if [[ $BUNDLE = true ]]; then
    if [ -d "spec/dummy" ]; then
        echo ">>> Building rbenv gemset"
        build_rbenv_gemset $(basename $(pwd))
    else
        echo ">>> Bundling gems"
        bundle
    fi
fi

if [[ $GITPULL = true ]]; then
    echo ">>> Pulling Git commits"

    if [[ -e "../list" ]]; then
        (
            cd ..
            git_pull_list
        )
    else
        git dn
    fi
fi

if [[ $CLEAN = true ]]; then
    if [ -d "spec/dummy" ]; then
        echo ">>> Cleaning spec/dummy"
        rails_engine_clean_spec_dummy
    fi
fi

if [[ $NUKESCHEMAS = true ]]; then
    nuke_schemas
fi

if [[ $TESTS = true ]]; then
    echo ">>> Running tests"
    bundle exec rake
fi
