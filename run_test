#!/usr/bin/env ruby

def die(msg)
  warn "#{ File.basename($0) }: ERROR: #{ msg }"
  exit 1
end

def main
  file_name, target = ARGV
  die 'no file name given' unless file_name

  case file_name
  when /spec\.rb$/
    line_number_spec = (target ? ":#{ target }" : '')
    exec "bundle exec rspec -f d #{ file_name }#{ line_number_spec }"
  when /\.js$/i
    if File.exist?('./node_modules/.bin/mocha')
      exec "./node_modules/.bin/mocha #{ file_name }"
    else
      die "can't figure out JavaScript test runner: #{ file_name }"
    end
  when /test\.rb$/
    exec "bundle exec rake test TEST=#{ file_name }"
  when /\.feature$/
    line_number_spec = (target ? ":#{ target }" : '')
    exec "SELENIUM_DRIVER=true bundle exec cucumber -r features #{ file_name }#{ line_number_spec }"
  when /test.*\.py$/
    if File.exist?('manage.py')
      label = File.basename(File.dirname(file_name))
      pattern = File.basename(file_name)
      if target
        exec "python manage.py test #{label} --pattern='*#{pattern}' --tag=only"
      else
        exec "python manage.py test #{label} --pattern='*#{pattern}'"
      end
    else
      die "couldn't find Python testing strategy: #{ file_name }"
    end
  else
    die "unrecognized file name: #{ file_name }"
  end
end

main if $0 == __FILE__
